#include <DS1302.h>
 
const int CLK = 5;                                   // Clock 을  5번핀 설정
const int DAT = 4;                                   // Data를  6번핀 설정
const int RST = 2;                                   // Reset을  7번핀 설정

DS1302 rtc(RST, DAT, CLK);              // DS1302  객체 설정

Time t;

const int pressurePin = A0;  // 압력 센서 연결 핀
const int buzzerPin = 9;    // 부저 연결 핀
int tones[] = {261, 277, 294, 311, 330, 349, 370, 392};
int numTones = 8;
int cnt = 0;

void setup() {
  //RTC 동작설정  
  rtc.halt(false);  
  rtc.writeProtect(true);   
  Serial.begin(57600);

  Serial.print("compiled: ");
  Serial.print(__DATE__);
  Serial.println(__TIME__);
  //컴파일 시점의 날짜(__DATE__)와 시간(__TIME__)을 시리얼모니터에 표시
 
 
  rtc.setDOW(FRIDAY);     // Set Day-of-Week  
  rtc.setTime(13, 38, 0);    // Set the time (HH:MM:SS)  
  rtc.setDate(6, 12, 2023);   // Set the date (DD.MM.YY)
  
  pinMode(pressurePin, INPUT);
  pinMode(buzzerPin, OUTPUT);
}

void loop() {
  int pressureThreshold = 500;  // 압력 감지 임계값 (조절 필요)

  unsigned long startTime = millis();  // 현재 시간 기록
  unsigned long duration = 0;
  unsigned long pressureDetectedTime = 0;
  bool pressureDetected = false;

  
  int SaveMin;  
  t = rtc.getTime(); //RTC에 저장된 시간을 들고옴    
 
  Serial.print(t.date - 13, DEC);  
  Serial.print(".");  
  Serial.print(rtc.getMonthStr());  
  Serial.print(".");  
  Serial.print(t.year - 31, DEC);
  Serial.println(".");
  Serial.print(t.hour - 3, DEC);
  Serial.print(" : "); 
  Serial.print(t.min, DEC);
  Serial.print(" : ");  
  Serial.println(t.sec, DEC);  
  delay (1000);
  
 //정해진 시간이 되면 부저를 울리고
  if(t.hour == 4 && t.min == 22 && t.sec == 0)  //원하는 시간 설정
  {    
    for(int i = 0; i < numTones; i++)  {
        tone(buzzerPin, tones[i]);
        delay(500);
      }
    
     //신호를 보낸다
     
   /*
    두 번째 아두이노로 신호를 보내는 코드
    */
      Serial.println("ringring!!!");
  }

  //두번째 아두이노에서 버튼 누르고 알람 끄는 중


    //두번째 아두이노에서 종료신호를 받으면 부저를 끄고 측정을 시작한다
       noTone(buzzerPin);
       delay(1000);
    
    //압력 센서로 측정하는 코드
  while (duration < 300000) {  // 30초(300,000 밀리초) 동안 반복
    int pressureValue = analogRead(pressurePin);
    Serial.println(pressureValue);

    // 일정 압력 이상인지 감지
    if (pressureValue > pressureThreshold) {
      pressureDetected = true;
      pressureDetectedTime += 1000;  // 압력이 감지된 시간 기록
      Serial.println(pressureDetectedTime);
    } 

    delay(1000);  // 1초 대기
    duration = millis() - startTime;  // 경과 시간 계산
  }

  // 300초가 끝나면 압력이 150초 이상 동안 감지되었는지 확인하고
    if (pressureDetectedTime >= 150000) {
      //부저를 울리고
      while(1){
      for(int i = 0; i < numTones; i++)  {
        tone(buzzerPin, tones[i]);
        delay(500);
      }
      //신호를 보낸다
      /*
       신호 보내는 코드
       */
       
      if(//종료 신호를 받으면)
        noTone(buzzerPin);
        delay(1000);
      
      }
    }
    else{
      cnt++; // 통과되면 count 증가
    }

  // 3번 통과되면 완전 종료
  if (cnt == 3){
     exit(0);
  }
}
